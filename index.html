<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’• æˆ‘ä»¬çš„å°çª</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fef9f3; --bg-secondary: #fff; --bg-card: #fff;
            --rose: #e8a4b8; --rose-light: #fce4ec; --rose-dark: #c48b9f;
            --text: #5d4e4e; --text-light: #8b7b7b; --shadow: rgba(200, 139, 159, 0.15);
            --gradient-header: linear-gradient(180deg, var(--rose-light) 0%, transparent 100%);
        }
        [data-theme="night"] {
            --bg-primary: #0f0c29; --bg-secondary: #1a1a3e; --bg-card: rgba(30, 30, 60, 0.95);
            --rose: #ff6b9d; --rose-light: #2d2d5a; --rose-dark: #ff8fab;
            --text: #e8e8f0; --text-light: #a8a8c0; --shadow: rgba(0, 0, 0, 0.3);
            --gradient-header: linear-gradient(180deg, rgba(255, 107, 157, 0.2) 0%, transparent 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Serif SC', serif; background: var(--bg-primary); color: var(--text); min-height: 100vh; overflow-x: hidden; transition: background 0.5s, color 0.5s; }
        .stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.5s; }
        [data-theme="night"] .stars { opacity: 1; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .falling-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
        .falling-item { position: absolute; top: -50px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }
        .cursor-trail { position: fixed; pointer-events: none; z-index: 9999; font-size: 20px; animation: trailFade 1s ease-out forwards; }
        @keyframes trailFade { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(0.5) translateY(-30px); } }

        .login-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.8s, transform 0.8s; }
        .login-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        .login-box { text-align: center; padding: 50px 40px; background: var(--bg-card); border-radius: 30px; box-shadow: 0 25px 80px var(--shadow); max-width: 400px; width: 90%; border: 1px solid rgba(232, 164, 184, 0.2); }
        .login-hearts { font-size: 50px; margin-bottom: 15px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .login-title { font-family: 'Ma Shan Zheng', cursive; font-size: 32px; color: var(--rose-dark); margin-bottom: 8px; }
        .login-subtitle { color: var(--text-light); font-size: 13px; margin-bottom: 30px; }
        .login-tabs { display: flex; margin-bottom: 25px; border-radius: 25px; overflow: hidden; background: var(--rose-light); }
        .login-tab { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text); cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .login-tab.active { background: var(--rose); color: white; }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .login-input { width: 100%; padding: 15px 20px; border: 2px solid var(--rose-light); border-radius: 25px; background: var(--bg-secondary); font-size: 15px; color: var(--text); transition: all 0.3s; font-family: inherit; margin-bottom: 12px; }
        .login-input:focus { outline: none; border-color: var(--rose); }
        .login-btn { width: 100%; padding: 15px; border: none; border-radius: 25px; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; font-size: 15px; cursor: pointer; transition: all 0.3s; font-family: inherit; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(232, 164, 184, 0.4); }
        .login-error { color: #e57373; font-size: 13px; margin-top: 12px; min-height: 20px; }
        .role-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 6px; }
        .role-badge.owner { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #333; }
        .role-badge.visitor { background: var(--rose-light); color: var(--rose-dark); }

        .user-bar { position: fixed; top: 20px; left: 20px; z-index: 100; display: flex; align-items: center; gap: 10px; padding: 8px 15px; background: var(--bg-card); border-radius: 25px; box-shadow: 0 3px 15px var(--shadow); }
        .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; background: var(--rose); display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .user-name { font-size: 13px; color: var(--text); }
        .logout-btn { padding: 5px 12px; border: none; background: var(--rose-light); color: var(--rose-dark); border-radius: 15px; cursor: pointer; font-size: 12px; font-family: inherit; }
        .logout-btn:hover { background: var(--rose); color: white; }

        .sync-status { position: fixed; bottom: 20px; left: 20px; z-index: 100; padding: 8px 15px; border-radius: 20px; font-size: 11px; background: var(--bg-card); box-shadow: 0 3px 15px var(--shadow); display: flex; align-items: center; gap: 6px; }
        .sync-status.syncing { color: #ffa726; }
        .sync-status.synced { color: #66bb6a; }
        .sync-status.error { color: #ef5350; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .sync-status.syncing .sync-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; gap: 8px; }
        .toggle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text); font-size: 18px; cursor: pointer; box-shadow: 0 3px 15px var(--shadow); transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .toggle-btn:hover { transform: scale(1.1); }
        .toggle-btn.active { background: var(--rose); color: white; }

        .app { display: none; min-height: 100vh; position: relative; z-index: 2; }
        .app.active { display: block; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header-decor { height: 180px; background: var(--gradient-header); }
        .main-card { max-width: 900px; margin: -80px auto 40px; background: var(--bg-card); border-radius: 35px; padding: 40px; box-shadow: 0 25px 80px var(--shadow); position: relative; z-index: 10; }

        .couple-section { display: flex; align-items: center; justify-content: center; gap: 25px; margin-bottom: 35px; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--bg-card); box-shadow: 0 8px 30px var(--shadow); transition: transform 0.3s; background: var(--rose-light); display: flex; align-items: center; justify-content: center; font-size: 35px; overflow: hidden; }
        .avatar:hover { transform: scale(1.05); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-name { text-align: center; margin-top: 10px; font-size: 14px; color: var(--text); font-weight: 500; }
        .heart-connector { font-size: 40px; color: var(--rose); animation: heartbeat 1.5s ease-in-out infinite; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        .timer-section { text-align: center; padding: 30px 0; border-top: 1px solid var(--rose-light); border-bottom: 1px solid var(--rose-light); margin-bottom: 30px; }
        .timer-title { font-family: 'ZCOOL XiaoWei', serif; font-size: 16px; color: var(--text-light); margin-bottom: 12px; }
        .timer-display { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .timer-unit { text-align: center; }
        .timer-number { font-family: 'Ma Shan Zheng', cursive; font-size: 48px; color: var(--rose-dark); line-height: 1; }
        .timer-label { font-size: 12px; color: var(--text-light); margin-top: 3px; }

        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: var(--rose-light); color: var(--text); border-radius: 25px; cursor: pointer; font-family: inherit; font-size: 13px; transition: all 0.3s; }
        .tab-btn:hover { background: var(--rose); color: white; }
        .tab-btn.active { background: var(--rose-dark); color: white; }
        .tab-content { display: none; animation: slideUp 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* ç§èŠæ ·å¼ */
        .chat-container { height: 500px; display: flex; flex-direction: column; background: var(--bg-secondary); border-radius: 20px; overflow: hidden; }
        .chat-header { padding: 15px 20px; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; display: flex; align-items: center; gap: 12px; }
        .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .chat-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-header-info { flex: 1; }
        .chat-header-name { font-weight: 500; font-size: 15px; }
        .chat-header-status { font-size: 11px; opacity: 0.9; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--rose-light); border-radius: 3px; }
        .chat-date-divider { text-align: center; font-size: 11px; color: var(--text-light); padding: 10px 0; }
        .chat-message { display: flex; gap: 10px; max-width: 80%; }
        .chat-message.mine { flex-direction: row-reverse; margin-left: auto; }
        .chat-message-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--rose-light); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; overflow: hidden; }
        .chat-message-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-message-content { display: flex; flex-direction: column; gap: 4px; }
        .chat-message.mine .chat-message-content { align-items: flex-end; }
        .chat-bubble { padding: 12px 16px; border-radius: 18px; background: var(--bg-card); box-shadow: 0 2px 8px var(--shadow); font-size: 14px; line-height: 1.5; word-break: break-word; }
        .chat-message.mine .chat-bubble { background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; }
        .chat-bubble img { max-width: 200px; border-radius: 12px; cursor: pointer; display: block; }
        .chat-message-time { font-size: 10px; color: var(--text-light); padding: 0 5px; }
        .chat-input-area { padding: 15px; background: var(--bg-card); border-top: 1px solid var(--rose-light); display: flex; gap: 10px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px 18px; border: 2px solid var(--rose-light); border-radius: 25px; font-family: inherit; font-size: 14px; color: var(--text); background: var(--bg-secondary); resize: none; max-height: 100px; }
        .chat-input:focus { outline: none; border-color: var(--rose); }
        .chat-btn { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; }
        .chat-btn-img { background: var(--rose-light); color: var(--rose-dark); }
        .chat-btn-img:hover { background: var(--rose); color: white; }
        .chat-btn-send { background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; }
        .chat-btn-send:hover { transform: scale(1.1); }
        .chat-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-light); }
        .chat-empty-icon { font-size: 60px; margin-bottom: 15px; }

        /* è¯´è¯´ç›¸å…³ */
        .post-form { background: var(--rose-light); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .post-form.hidden { display: none; }
        .post-textarea { width: 100%; min-height: 80px; border: none; background: var(--bg-card); border-radius: 15px; padding: 15px; font-family: inherit; font-size: 14px; resize: none; color: var(--text); }
        .post-textarea:focus { outline: none; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; flex-wrap: wrap; gap: 10px; }
        .post-image-btn { padding: 8px 16px; border: 2px dashed var(--rose); background: transparent; color: var(--rose-dark); border-radius: 18px; cursor: pointer; font-family: inherit; font-size: 13px; }
        .post-image-btn:hover { background: var(--rose); color: white; border-style: solid; }
        .post-submit { padding: 10px 28px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 13px; }
        .post-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .post-image-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .preview-item { width: 70px; height: 70px; border-radius: 10px; overflow: hidden; position: relative; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; font-size: 11px; }
        .posts-list { display: flex; flex-direction: column; gap: 20px; }
        .post-item { background: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--rose-light); }
        .post-item-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .post-item-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--rose); display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .post-item-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .post-item-info { flex: 1; }
        .post-item-name { font-weight: 500; color: var(--text); font-size: 14px; display: flex; align-items: center; }
        .post-item-date { font-size: 11px; color: var(--text-light); margin-top: 2px; }
        .post-item-delete { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 16px; opacity: 0; transition: opacity 0.3s; }
        .post-item:hover .post-item-delete { opacity: 1; }
        .post-item-content { line-height: 1.7; white-space: pre-wrap; margin-bottom: 12px; font-size: 14px; }
        .post-item-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px; }
        .post-item-images.single { grid-template-columns: 1fr; max-width: 350px; }
        .post-item-images.double { grid-template-columns: repeat(2, 1fr); max-width: 350px; }
        .post-item-images img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; cursor: pointer; }
        .post-item-footer { display: flex; gap: 15px; padding-top: 12px; border-top: 1px solid var(--rose-light); }
        .post-action-btn { display: flex; align-items: center; gap: 5px; background: none; border: none; color: var(--text-light); cursor: pointer; font-family: inherit; font-size: 13px; padding: 6px 12px; border-radius: 15px; transition: all 0.3s; }
        .post-action-btn:hover { background: var(--rose-light); color: var(--rose-dark); }
        .post-action-btn.liked { color: var(--rose); }

        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--rose-light); }
        .comment-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--rose-light); }
        .comment-item:last-child { border-bottom: none; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--rose-light); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .comment-content { flex: 1; }
        .comment-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .comment-name { font-size: 13px; font-weight: 500; }
        .comment-date { font-size: 11px; color: var(--text-light); }
        .comment-text { font-size: 13px; line-height: 1.5; }
        .comment-reply-to { color: var(--rose); font-size: 12px; margin-bottom: 3px; }
        .comment-actions { margin-top: 5px; }
        .comment-action-btn { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 11px; padding: 2px 8px; }
        .comment-action-btn:hover { color: var(--rose); }
        .comment-form { display: flex; gap: 8px; margin-top: 10px; }
        .comment-input { flex: 1; padding: 10px 15px; border: 2px solid var(--rose-light); border-radius: 20px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--bg-secondary); }
        .comment-input:focus { outline: none; border-color: var(--rose); }
        .comment-submit { padding: 10px 20px; border: none; background: var(--rose); color: white; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .reply-hint { font-size: 12px; color: var(--rose); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .reply-hint button { background: none; border: none; color: var(--text-light); cursor: pointer; }

        /* å…¶ä»–æ ‡ç­¾é¡µ */
        .album-filters { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 16px; border: 2px solid var(--rose-light); background: transparent; color: var(--text); border-radius: 18px; cursor: pointer; font-size: 12px; }
        .filter-btn:hover, .filter-btn.active { background: var(--rose); border-color: var(--rose); color: white; }
        .album-upload-section { background: var(--rose-light); border-radius: 18px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .album-upload-section.hidden { display: none; }
        .album-category-select { padding: 8px 16px; border: 2px solid var(--rose); border-radius: 18px; background: var(--bg-card); color: var(--text); font-size: 13px; }
        .album-upload-btn { padding: 8px 20px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 18px; cursor: pointer; font-size: 13px; }
        .masonry-grid { column-count: 3; column-gap: 12px; }
        .masonry-item { break-inside: avoid; margin-bottom: 12px; border-radius: 14px; overflow: hidden; position: relative; cursor: pointer; }
        .masonry-item:hover { transform: scale(1.02); }
        .masonry-item img { width: 100%; display: block; }
        .masonry-item .photo-category { position: absolute; top: 8px; left: 8px; padding: 3px 10px; background: rgba(0,0,0,0.5); color: white; border-radius: 10px; font-size: 11px; }
        .masonry-item .photo-delete { position: absolute; top: 8px; right: 8px; width: 26px; height: 26px; border-radius: 50%; background: rgba(0,0,0,0.5); color: white; border: none; cursor: pointer; display: none; }
        .masonry-item:hover .photo-delete { display: flex; align-items: center; justify-content: center; }
        .album-empty { text-align: center; padding: 50px 20px; color: var(--text-light); }
        .album-empty-icon { font-size: 50px; margin-bottom: 12px; }

        .diary-form { background: var(--rose-light); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .diary-form.hidden { display: none; }
        .diary-textarea { width: 100%; min-height: 100px; border: none; background: var(--bg-card); border-radius: 15px; padding: 15px; font-family: inherit; font-size: 14px; resize: none; color: var(--text); }
        .diary-submit { padding: 10px 28px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 20px; cursor: pointer; font-size: 13px; margin-top: 12px; }
        .diary-list { display: flex; flex-direction: column; gap: 15px; }
        .diary-entry { background: var(--bg-card); border-radius: 20px; padding: 20px; border-left: 4px solid var(--rose); box-shadow: 0 4px 15px var(--shadow); position: relative; }
        .diary-date { font-size: 11px; color: var(--text-light); margin-bottom: 8px; }
        .diary-content { line-height: 1.7; white-space: pre-wrap; font-size: 14px; }
        .diary-entry .delete-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 16px; opacity: 0; }
        .diary-entry:hover .delete-btn { opacity: 1; }

        .wishlist-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .wishlist-form.hidden { display: none; }
        .wishlist-input { flex: 1; padding: 12px 20px; border: 2px solid var(--rose-light); border-radius: 25px; font-family: inherit; font-size: 14px; color: var(--text); background: var(--bg-card); }
        .wishlist-add { padding: 12px 25px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 25px; cursor: pointer; font-size: 13px; }
        .wishlist-items { display: flex; flex-direction: column; gap: 10px; }
        .wishlist-item { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: var(--bg-card); border-radius: 18px; box-shadow: 0 3px 12px var(--shadow); }
        .wishlist-item.completed { background: var(--rose-light); }
        .wishlist-item.completed .wishlist-text { text-decoration: line-through; color: var(--text-light); }
        .wishlist-checkbox { width: 22px; height: 22px; border: 2px solid var(--rose); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .wishlist-checkbox.checked { background: var(--rose); color: white; }
        .wishlist-text { flex: 1; font-size: 14px; }
        .wishlist-delete { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 16px; opacity: 0; }
        .wishlist-item:hover .wishlist-delete { opacity: 1; }

        .settings-section { background: var(--rose-light); border-radius: 20px; padding: 25px; margin-bottom: 15px; }
        .settings-title { font-family: 'ZCOOL XiaoWei', serif; font-size: 16px; margin-bottom: 15px; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.3); flex-wrap: wrap; gap: 10px; }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { font-size: 13px; }
        .settings-input { padding: 8px 16px; border: 2px solid var(--bg-card); border-radius: 18px; font-size: 13px; background: var(--bg-card); color: var(--text); }
        .settings-btn { padding: 8px 20px; border: none; background: var(--rose-dark); color: white; border-radius: 18px; cursor: pointer; font-size: 13px; }
        .settings-btn:hover { background: var(--rose); }
        .settings-btn.danger { background: #e57373; }
        .visitor-list { margin-top: 15px; }
        .visitor-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: var(--bg-card); border-radius: 12px; margin-bottom: 8px; }
        .add-visitor-form { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .add-visitor-form input { padding: 8px 15px; border: 2px solid var(--rose-light); border-radius: 18px; font-size: 13px; background: var(--bg-card); color: var(--text); }

        .footer { text-align: center; padding: 30px 20px; color: var(--text-light); font-size: 12px; }
        .footer-heart { color: var(--rose); animation: heartbeat 1.5s ease-in-out infinite; display: inline-block; }
        .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .hidden-input { display: none; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 45px; height: 45px; border: 4px solid var(--rose-light); border-top-color: var(--rose); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) { .masonry-grid { column-count: 2; } .chat-container { height: 450px; } }
        @media (max-width: 600px) {
            .main-card { margin: -60px 12px 30px; padding: 25px 18px; border-radius: 28px; }
            .couple-section { gap: 15px; }
            .avatar { width: 75px; height: 75px; font-size: 28px; }
            .heart-connector { font-size: 28px; }
            .timer-number { font-size: 38px; }
            .tabs { gap: 5px; }
            .tab-btn { padding: 8px 12px; font-size: 11px; }
            .wishlist-form { flex-direction: column; }
            .login-box { padding: 35px 25px; }
            .theme-toggle { top: 12px; right: 12px; }
            .toggle-btn { width: 38px; height: 38px; font-size: 16px; }
            .user-bar { top: 12px; left: 12px; padding: 6px 12px; }
            .chat-container { height: 400px; }
            .chat-bubble img { max-width: 150px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="falling-container" id="fallingContainer"></div>

    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-hearts">ğŸ’‘</div>
            <h1 class="login-title">æˆ‘ä»¬çš„å°çª</h1>
            <p class="login-subtitle">ç™»å½•è¿›å…¥ä¸“å±ç©ºé—´</p>
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('owner')">ğŸ‘‘ ä¸»äºº</button>
                <button class="login-tab" onclick="switchLoginTab('visitor')">ğŸ‘€ è®¿å®¢</button>
            </div>
            <div class="login-form active" id="ownerLoginForm">
                <select class="login-input" id="ownerSelect"><option value="yhr">yhr ğŸ‘¦</option><option value="hhy">hhy ğŸ‘§</option></select>
                <input type="password" class="login-input" id="ownerPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button class="login-btn" onclick="ownerLogin()">è¿›å…¥å°çª ğŸ’•</button>
            </div>
            <div class="login-form" id="visitorLoginForm">
                <input type="text" class="login-input" id="visitorUsername" placeholder="è®¿å®¢æ˜µç§°">
                <input type="password" class="login-input" id="visitorPassword" placeholder="è®¿å®¢å¯†ç ">
                <button class="login-btn" onclick="visitorLogin()">è®¿å®¢è¿›å…¥ ğŸ‘€</button>
            </div>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <div class="user-bar" id="userBar" style="display:none;">
        <div class="user-avatar-small" id="userAvatarSmall">ğŸ‘¤</div>
        <span class="user-name" id="userName">ç”¨æˆ·</span>
        <button class="logout-btn" onclick="logout()">é€€å‡º</button>
    </div>
    <div class="sync-status synced" id="syncStatus"><div class="sync-dot"></div><span>å·²åŒæ­¥</span></div>
    <div class="theme-toggle">
        <button class="toggle-btn active" id="btnHearts" onclick="setFallingType('hearts')">â¤ï¸</button>
        <button class="toggle-btn" id="btnPetals" onclick="setFallingType('petals')">ğŸŒ¸</button>
        <button class="toggle-btn" id="btnTheme" onclick="toggleTheme()">ğŸŒ™</button>
    </div>

    <div class="app" id="app">
        <div class="header-decor"></div>
        <div class="main-card">
            <div class="couple-section">
                <div class="avatar-wrapper">
                    <div class="avatar" id="avatar1">ğŸ‘¦</div>
                    <input type="file" id="avatarInput1" class="hidden-input" accept="image/*" onchange="uploadAvatar(1,this)">
                    <div class="avatar-name" id="name1Display">ä»–</div>
                </div>
                <div class="heart-connector">ğŸ’•</div>
                <div class="avatar-wrapper">
                    <div class="avatar" id="avatar2">ğŸ‘§</div>
                    <input type="file" id="avatarInput2" class="hidden-input" accept="image/*" onchange="uploadAvatar(2,this)">
                    <div class="avatar-name" id="name2Display">å¥¹</div>
                </div>
            </div>
            <div class="timer-section">
                <p class="timer-title">æˆ‘ä»¬åœ¨ä¸€èµ·å·²ç»</p>
                <div class="timer-display">
                    <div class="timer-unit"><div class="timer-number" id="timerDays">0</div><div class="timer-label">å¤©</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerHours">0</div><div class="timer-label">æ—¶</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerMinutes">0</div><div class="timer-label">åˆ†</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerSeconds">0</div><div class="timer-label">ç§’</div></div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('posts',this)">ğŸ’¬ è¯´è¯´</button>
                <button class="tab-btn" id="chatTab" onclick="switchTab('chat',this)">ğŸ’Œ ç§èŠ</button>
                <button class="tab-btn" onclick="switchTab('album',this)">ğŸ“¸ ç›¸å†Œ</button>
                <button class="tab-btn" onclick="switchTab('diary',this)">ğŸ“ æ—¥è®°</button>
                <button class="tab-btn" onclick="switchTab('wishlist',this)">ğŸ¯ æ¸…å•</button>
                <button class="tab-btn" id="settingsTab" onclick="switchTab('settings',this)">âš™ï¸</button>
            </div>

            <!-- è¯´è¯´ -->
            <div class="tab-content active" id="tab-posts">
                <div class="post-form" id="postForm">
                    <textarea class="post-textarea" id="postContent" placeholder="åˆ†äº«æ­¤åˆ»çš„å¿ƒæƒ…..."></textarea>
                    <div class="post-image-preview" id="postImagePreview"></div>
                    <div class="post-actions">
                        <button class="post-image-btn" onclick="document.getElementById('postImageInput').click()">ğŸ“· å›¾ç‰‡</button>
                        <input type="file" id="postImageInput" class="hidden-input" accept="image/*" multiple onchange="previewPostImages(this)">
                        <button class="post-submit" id="postSubmitBtn" onclick="publishPost()">å‘å¸ƒ ğŸ’Œ</button>
                    </div>
                </div>
                <div class="posts-list" id="postsList"></div>
            </div>

            <!-- ç§èŠ -->
            <div class="tab-content" id="tab-chat">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-header-avatar" id="chatPartnerAvatar">ğŸ’•</div>
                        <div class="chat-header-info">
                            <div class="chat-header-name" id="chatPartnerName">æˆ‘ä»¬çš„æ‚„æ‚„è¯</div>
                            <div class="chat-header-status">ğŸ’• åªæœ‰æˆ‘ä»¬èƒ½çœ‹åˆ°</div>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-empty"><div class="chat-empty-icon">ğŸ’Œ</div><p>å¼€å§‹ä½ ä»¬çš„æ‚„æ‚„è¯å§ï½</p></div>
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-btn chat-btn-img" onclick="document.getElementById('chatImageInput').click()">ğŸ“·</button>
                        <input type="file" id="chatImageInput" class="hidden-input" accept="image/*" onchange="sendChatImage(this)">
                        <textarea class="chat-input" id="chatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." rows="1" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                        <button class="chat-btn chat-btn-send" onclick="sendMessage()">ğŸ’Œ</button>
                    </div>
                </div>
            </div>

            <!-- ç›¸å†Œ -->
            <div class="tab-content" id="tab-album">
                <div class="album-filters">
                    <button class="filter-btn active" onclick="filterAlbum('all',this)">å…¨éƒ¨</button>
                    <button class="filter-btn" onclick="filterAlbum('daily',this)">ğŸ“… æ—¥å¸¸</button>
                    <button class="filter-btn" onclick="filterAlbum('date',this)">ğŸ’‘ çº¦ä¼š</button>
                    <button class="filter-btn" onclick="filterAlbum('travel',this)">âœˆï¸ æ—…è¡Œ</button>
                    <button class="filter-btn" onclick="filterAlbum('food',this)">ğŸœ ç¾é£Ÿ</button>
                </div>
                <div class="album-upload-section" id="albumUploadSection">
                    <select class="album-category-select" id="albumCategory">
                        <option value="daily">ğŸ“… æ—¥å¸¸</option><option value="date">ğŸ’‘ çº¦ä¼š</option>
                        <option value="travel">âœˆï¸ æ—…è¡Œ</option><option value="food">ğŸœ ç¾é£Ÿ</option>
                    </select>
                    <button class="album-upload-btn" onclick="document.getElementById('photoInput').click()">ğŸ“· ä¸Šä¼ </button>
                    <input type="file" id="photoInput" class="hidden-input" accept="image/*" multiple onchange="uploadPhotos(this)">
                </div>
                <div class="masonry-grid" id="albumGrid"></div>
                <div class="album-empty" id="albumEmpty" style="display:none;"><div class="album-empty-icon">ğŸ“·</div><p>è¿˜æ²¡æœ‰ç…§ç‰‡</p></div>
            </div>

            <!-- æ—¥è®° -->
            <div class="tab-content" id="tab-diary">
                <div class="diary-form" id="diaryForm">
                    <textarea class="diary-textarea" id="diaryInput" placeholder="è®°å½•ä»Šå¤©çš„ç‚¹æ»´..."></textarea>
                    <button class="diary-submit" onclick="addDiary()">å‘å¸ƒ ğŸ’Œ</button>
                </div>
                <div class="diary-list" id="diaryList"></div>
            </div>

            <!-- æ¸…å• -->
            <div class="tab-content" id="tab-wishlist">
                <div class="wishlist-form" id="wishlistForm">
                    <input type="text" class="wishlist-input" id="wishInput" placeholder="æƒ³ä¸€èµ·åšçš„äº‹...">
                    <button class="wishlist-add" onclick="addWish()">æ·»åŠ </button>
                </div>
                <div class="wishlist-items" id="wishList"></div>
            </div>

            <!-- è®¾ç½® -->
            <div class="tab-content" id="tab-settings">
                <div class="settings-section">
                    <h3 class="settings-title">ğŸ’‘ åŸºæœ¬è®¾ç½®</h3>
                    <div class="settings-item">
                        <span class="settings-label">åœ¨ä¸€èµ·çš„æ—¥æœŸ</span>
                        <input type="date" class="settings-input" id="startDate" onchange="saveConfig()">
                    </div>
                    <div class="settings-item">
                        <span class="settings-label">ä¿®æ”¹å¤´åƒ</span>
                        <div>
                            <button class="settings-btn" onclick="document.getElementById('avatarInput1').click()" style="margin-right:5px">ä»–</button>
                            <button class="settings-btn" onclick="document.getElementById('avatarInput2').click()">å¥¹</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <h3 class="settings-title">ğŸ” ä¿®æ”¹å¯†ç </h3>
                    <div class="settings-item">
                        <span class="settings-label">æ—§å¯†ç </span>
                        <input type="password" class="settings-input" id="oldPassword" placeholder="è¾“å…¥æ—§å¯†ç ">
                    </div>
                    <div class="settings-item">
                        <span class="settings-label">æ–°å¯†ç </span>
                        <input type="password" class="settings-input" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="settings-item">
                        <span class="settings-label">ç¡®è®¤å¯†ç </span>
                        <input type="password" class="settings-input" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="settings-item"><span></span><button class="settings-btn" onclick="changePassword()">ä¿®æ”¹å¯†ç </button></div>
                </div>
                <div class="settings-section">
                    <h3 class="settings-title">ğŸ‘€ è®¿å®¢ç®¡ç†</h3>
                    <p style="font-size:11px;color:var(--text-light);margin-bottom:10px">è®¿å®¢å¯ä»¥æµè§ˆã€ç‚¹èµå’Œè¯„è®º</p>
                    <div class="visitor-list" id="visitorList"></div>
                    <div class="add-visitor-form">
                        <input type="text" id="newVisitorName" placeholder="æ˜µç§°">
                        <input type="password" id="newVisitorPwd" placeholder="å¯†ç ">
                        <button class="settings-btn" onclick="addVisitor()">æ·»åŠ </button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer">ç”¨ <span class="footer-heart">â¤ï¸</span> è®°å½•æ¯ä¸€å¤©</footer>
    </div>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightboxImg" src=""></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <script>
        const SUPABASE_URL = 'https://qzsnxxvjxzvgnzaliwsa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6c254eHZqeHp2Z256YWxpd3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTgwMDQsImV4cCI6MjA4NTg3NDAwNH0.nlNdUMLzNg8QAu01xHrrhHq1R377KUjfaVUhchOrttA';

        async function db(table, method = 'GET', body = null, query = '') {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
                method, headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        }

        let currentUser = null;
        let config = { start_date: '', name1: 'yhr', name2: 'hhy', avatar1: '', avatar2: '' };
        let posts = [], photos = [], diaries = [], wishes = [], users = [], comments = [], likes = [], messages = [];
        let pendingPostImages = [], currentFilter = 'all', replyTo = null;
        let fallingType = localStorage.getItem('fallingType') || 'hearts';
        let chatPollInterval = null;

        document.addEventListener('DOMContentLoaded', async () => {
            createStars(); initTheme(); updateFallingButtons(); startFalling(); initCursorTrail();
            document.getElementById('ownerPassword').onkeypress = e => { if (e.key === 'Enter') ownerLogin(); };
            document.getElementById('visitorPassword').onkeypress = e => { if (e.key === 'Enter') visitorLogin(); };
            document.getElementById('wishInput').onkeypress = e => { if (e.key === 'Enter') addWish(); };
            await loadConfig();
        });

        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.login-tab:${tab === 'owner' ? 'first' : 'last'}-child`).classList.add('active');
            document.getElementById(tab === 'owner' ? 'ownerLoginForm' : 'visitorLoginForm').classList.add('active');
            document.getElementById('loginError').textContent = '';
        }

        async function ownerLogin() {
            const username = document.getElementById('ownerSelect').value;
            const password = document.getElementById('ownerPassword').value;
            if (!password) { document.getElementById('loginError').textContent = 'è¯·è¾“å…¥å¯†ç '; return; }
            try {
                const u = await db('users', 'GET', null, `?username=eq.${encodeURIComponent(username)}&role=eq.owner`);
                if (u?.length && u[0].password === password) { currentUser = { username: u[0].username, role: 'owner', id: u[0].id }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); showApp(); }
                else { document.getElementById('loginError').textContent = 'å¯†ç é”™è¯¯'; }
            } catch (e) { document.getElementById('loginError').textContent = 'ç™»å½•å¤±è´¥'; }
        }

        async function visitorLogin() {
            const username = document.getElementById('visitorUsername').value.trim();
            const password = document.getElementById('visitorPassword').value;
            if (!username || !password) { document.getElementById('loginError').textContent = 'è¯·è¾“å…¥æ˜µç§°å’Œå¯†ç '; return; }
            try {
                const u = await db('users', 'GET', null, `?username=eq.${encodeURIComponent(username)}&role=eq.visitor`);
                if (u?.length && u[0].password === password) { currentUser = { username: u[0].username, role: 'visitor', id: u[0].id }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); showApp(); }
                else { document.getElementById('loginError').textContent = 'æ˜µç§°æˆ–å¯†ç é”™è¯¯'; }
            } catch (e) { document.getElementById('loginError').textContent = 'ç™»å½•å¤±è´¥'; }
        }

        function logout() {
            currentUser = null; sessionStorage.removeItem('currentUser');
            if (chatPollInterval) clearInterval(chatPollInterval);
            document.getElementById('app').classList.remove('active');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('userBar').style.display = 'none';
        }

        async function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.add('active');
            document.getElementById('userBar').style.display = 'flex';
            document.getElementById('userName').innerHTML = currentUser.username + `<span class="role-badge ${currentUser.role}">${currentUser.role === 'owner' ? 'ğŸ‘‘' : 'ğŸ‘€'}</span>`;
            
            const isOwner = currentUser.role === 'owner';
            document.getElementById('postForm').classList.toggle('hidden', !isOwner);
            document.getElementById('diaryForm').classList.toggle('hidden', !isOwner);
            document.getElementById('wishlistForm').classList.toggle('hidden', !isOwner);
            document.getElementById('albumUploadSection').classList.toggle('hidden', !isOwner);
            document.getElementById('settingsTab').style.display = isOwner ? '' : 'none';
            document.getElementById('chatTab').style.display = isOwner ? '' : 'none';
            document.getElementById('avatar1').onclick = isOwner ? () => document.getElementById('avatarInput1').click() : null;
            document.getElementById('avatar2').onclick = isOwner ? () => document.getElementById('avatarInput2').click() : null;
            document.getElementById('avatar1').style.cursor = document.getElementById('avatar2').style.cursor = isOwner ? 'pointer' : 'default';

            await loadAllData();
            startTimer();
            if (isOwner) startChatPolling();
        }

        async function loadConfig() {
            try {
                setSyncStatus('syncing', 'è¿æ¥ä¸­...');
                const data = await db('config', 'GET', null, '?id=eq.main');
                if (data?.length) config = { ...config, ...data[0] };
                setSyncStatus('synced', 'å·²è¿æ¥');
            } catch (e) { setSyncStatus('error', 'è¿æ¥å¤±è´¥'); }
        }

        async function loadAllData() {
            showLoading();
            try {
                setSyncStatus('syncing', 'åŠ è½½ä¸­...');
                const [p, ph, d, w, u, c, l, m] = await Promise.all([
                    db('posts', 'GET', null, '?order=created_at.desc'),
                    db('photos', 'GET', null, '?order=created_at.desc'),
                    db('diaries', 'GET', null, '?order=created_at.desc'),
                    db('wishes', 'GET', null, '?order=created_at.asc'),
                    db('users', 'GET', null, ''),
                    db('comments', 'GET', null, '?order=created_at.asc'),
                    db('likes', 'GET', null, ''),
                    db('messages', 'GET', null, '?order=created_at.asc')
                ]);
                posts = p || []; photos = ph || []; diaries = d || []; wishes = w || []; users = u || []; comments = c || []; likes = l || []; messages = m || [];
                renderConfig(); loadPosts(); loadPhotos(); loadDiaries(); loadWishes(); loadVisitors(); loadChatMessages();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (e) { setSyncStatus('error', 'åŠ è½½å¤±è´¥'); console.error(e); }
            hideLoading();
        }

        function renderConfig() {
            document.getElementById('startDate').value = config.start_date || '';
            document.getElementById('name1Display').textContent = config.name1 || 'yhr';
            document.getElementById('name2Display').textContent = config.name2 || 'hhy';
            if (config.avatar1) document.getElementById('avatar1').innerHTML = `<img src="${config.avatar1}">`;
            if (config.avatar2) document.getElementById('avatar2').innerHTML = `<img src="${config.avatar2}">`;
            updateChatHeader();
        }

        async function saveConfig() {
            config.start_date = document.getElementById('startDate').value;
            try { await db('config', 'PATCH', { start_date: config.start_date, avatar1: config.avatar1, avatar2: config.avatar2 }, '?id=eq.main'); setSyncStatus('synced', 'å·²åŒæ­¥'); }
            catch (e) { setSyncStatus('error', 'ä¿å­˜å¤±è´¥'); }
        }

        // ==================== ç§èŠåŠŸèƒ½ ====================
        function updateChatHeader() {
            const isYhr = currentUser?.username === 'yhr' || currentUser?.username === config.name1;
            const partner = isYhr ? (config.name2 || 'hhy') : (config.name1 || 'yhr');
            const partnerAvatar = isYhr ? config.avatar2 : config.avatar1;
            document.getElementById('chatPartnerName').textContent = `å’Œ${partner}çš„æ‚„æ‚„è¯`;
            document.getElementById('chatPartnerAvatar').innerHTML = partnerAvatar ? `<img src="${partnerAvatar}">` : 'ğŸ’•';
        }

        function loadChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!messages.length) {
                container.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon">ğŸ’Œ</div><p>å¼€å§‹ä½ ä»¬çš„æ‚„æ‚„è¯å§ï½</p></div>';
                return;
            }
            
            let html = '';
            let lastDate = '';
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toLocaleDateString('zh-CN');
                if (msgDate !== lastDate) {
                    html += `<div class="chat-date-divider">${msgDate}</div>`;
                    lastDate = msgDate;
                }
                const isMine = msg.sender === currentUser?.username;
                const isName1 = msg.sender === 'yhr' || msg.sender === config.name1;
                const avatar = isName1 ? config.avatar1 : config.avatar2;
                const time = new Date(msg.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                let content = '';
                if (msg.image) content = `<img src="${msg.image}" onclick="openLightbox('${msg.image.replace(/'/g, "\\'")}')">`;
                else if (msg.content) content = escapeHtml(msg.content);
                
                html += `<div class="chat-message ${isMine ? 'mine' : ''}">
                    <div class="chat-message-avatar">${avatar ? `<img src="${avatar}">` : (isName1 ? 'ğŸ‘¦' : 'ğŸ‘§')}</div>
                    <div class="chat-message-content">
                        <div class="chat-bubble">${content}</div>
                        <div class="chat-message-time">${time}</div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;
            
            try {
                await db('messages', 'POST', { sender: currentUser.username, content });
                input.value = '';
                messages = await db('messages', 'GET', null, '?order=created_at.asc') || [];
                loadChatMessages();
            } catch (e) { console.error(e); alert('å‘é€å¤±è´¥'); }
        }

        async function sendChatImage(input) {
            const file = input.files[0];
            if (!file) return;
            showLoading();
            try {
                const dataUrl = await readFileAsDataURL(file);
                const compressed = await compressImage(dataUrl, 600, 0.7);
                await db('messages', 'POST', { sender: currentUser.username, image: compressed });
                messages = await db('messages', 'GET', null, '?order=created_at.asc') || [];
                loadChatMessages();
            } catch (e) { console.error(e); alert('å‘é€å¤±è´¥'); }
            hideLoading();
            input.value = '';
        }

        function startChatPolling() {
            if (chatPollInterval) clearInterval(chatPollInterval);
            chatPollInterval = setInterval(async () => {
                try {
                    const newMessages = await db('messages', 'GET', null, '?order=created_at.asc');
                    if (newMessages && newMessages.length !== messages.length) {
                        messages = newMessages;
                        loadChatMessages();
                    }
                } catch (e) { console.error(e); }
            }, 5000);
        }

        // ==================== è¯´è¯´åŠŸèƒ½ ====================
        function previewPostImages(input) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => compressImage(e.target.result, 800, 0.7).then(c => { pendingPostImages.push(c); renderPostImagePreview(); });
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        function renderPostImagePreview() {
            document.getElementById('postImagePreview').innerHTML = pendingPostImages.map((img, i) =>
                `<div class="preview-item"><img src="${img}"><button class="preview-remove" onclick="pendingPostImages.splice(${i},1);renderPostImagePreview()">Ã—</button></div>`
            ).join('');
        }

        async function publishPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content && !pendingPostImages.length) return;
            const btn = document.getElementById('postSubmitBtn');
            btn.disabled = true; btn.textContent = 'å‘å¸ƒä¸­...';
            try {
                await db('posts', 'POST', { author: currentUser.username, content, images: pendingPostImages, likes: 0 });
                document.getElementById('postContent').value = ''; pendingPostImages = []; document.getElementById('postImagePreview').innerHTML = '';
                posts = await db('posts', 'GET', null, '?order=created_at.desc') || [];
                loadPosts();
            } catch (e) { alert('å‘å¸ƒå¤±è´¥'); }
            btn.disabled = false; btn.textContent = 'å‘å¸ƒ ğŸ’Œ';
        }

        function loadPosts() {
            const isOwner = currentUser?.role === 'owner';
            document.getElementById('postsList').innerHTML = posts.map(post => {
                const isName1 = post.author === 'yhr' || post.author === config.name1;
                const avatar = isName1 ? config.avatar1 : config.avatar2;
                const date = new Date(post.created_at).toLocaleString('zh-CN');
                const postLikes = likes.filter(l => l.post_id === post.id);
                const isLiked = postLikes.some(l => l.username === currentUser?.username);
                const postComments = comments.filter(c => c.post_id === post.id);
                
                let imagesHtml = '';
                if (post.images?.length) {
                    const gc = post.images.length === 1 ? 'single' : post.images.length === 2 ? 'double' : '';
                    imagesHtml = `<div class="post-item-images ${gc}">${post.images.map(img => `<img src="${img}" onclick="openLightbox('${img.replace(/'/g, "\\'")}')"/>`).join('')}</div>`;
                }
                
                const commentsHtml = `<div class="comments-section">
                    <div class="comments-list">${postComments.map(c => {
                        const replyComment = c.reply_to ? postComments.find(pc => pc.id === c.reply_to) : null;
                        return `<div class="comment-item">
                            <div class="comment-avatar">${c.username === 'yhr' || c.username === config.name1 ? 'ğŸ‘¦' : c.username === 'hhy' || c.username === config.name2 ? 'ğŸ‘§' : 'ğŸ‘¤'}</div>
                            <div class="comment-content">
                                <div class="comment-header"><span class="comment-name">${escapeHtml(c.username)}</span><span class="comment-date">${new Date(c.created_at).toLocaleString('zh-CN')}</span></div>
                                ${replyComment ? `<div class="comment-reply-to">å›å¤ @${escapeHtml(replyComment.username)}</div>` : ''}
                                <div class="comment-text">${escapeHtml(c.content)}</div>
                                <div class="comment-actions">
                                    <button class="comment-action-btn" onclick="setReplyTo(${post.id},${c.id},'${escapeHtml(c.username)}')">å›å¤</button>
                                    ${isOwner ? `<button class="comment-action-btn" onclick="deleteComment(${c.id},${post.id})">åˆ é™¤</button>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}</div>
                    <div id="replyHint-${post.id}" class="reply-hint" style="display:none"></div>
                    <div class="comment-form">
                        <input type="text" class="comment-input" id="commentInput-${post.id}" placeholder="å†™è¯„è®º..." onkeypress="if(event.key==='Enter')submitComment(${post.id})">
                        <button class="comment-submit" onclick="submitComment(${post.id})">å‘é€</button>
                    </div>
                </div>`;

                return `<div class="post-item">
                    <div class="post-item-header">
                        <div class="post-item-avatar">${avatar ? `<img src="${avatar}">` : (isName1 ? 'ğŸ‘¦' : 'ğŸ‘§')}</div>
                        <div class="post-item-info">
                            <div class="post-item-name">${escapeHtml(post.author)}<span class="role-badge owner">ğŸ‘‘</span></div>
                            <div class="post-item-date">${date}</div>
                        </div>
                        ${isOwner ? `<button class="post-item-delete" onclick="deletePost(${post.id})">Ã—</button>` : ''}
                    </div>
                    ${post.content ? `<div class="post-item-content">${escapeHtml(post.content)}</div>` : ''}
                    ${imagesHtml}
                    <div class="post-item-footer">
                        <button class="post-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id})">${isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${postLikes.length}</button>
                        <button class="post-action-btn" onclick="document.getElementById('commentInput-${post.id}').focus()">ğŸ’¬ ${postComments.length}</button>
                    </div>
                    ${commentsHtml}
                </div>`;
            }).join('');
        }

        async function toggleLike(postId) {
            const existing = likes.find(l => l.post_id === postId && l.username === currentUser.username);
            try {
                if (existing) { await db('likes', 'DELETE', null, `?id=eq.${existing.id}`); likes = likes.filter(l => l.id !== existing.id); }
                else { const res = await db('likes', 'POST', { post_id: postId, username: currentUser.username }); if (res?.[0]) likes.push(res[0]); }
                loadPosts();
            } catch (e) { console.error(e); }
        }

        async function deletePost(postId) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            try { await db('posts', 'DELETE', null, `?id=eq.${postId}`); posts = posts.filter(p => p.id !== postId); comments = comments.filter(c => c.post_id !== postId); likes = likes.filter(l => l.post_id !== postId); loadPosts(); }
            catch (e) { console.error(e); }
        }

        function setReplyTo(postId, commentId, username) {
            replyTo = { postId, commentId, username };
            const hint = document.getElementById(`replyHint-${postId}`);
            hint.innerHTML = `å›å¤ @${username} <button onclick="cancelReply(${postId})">Ã—</button>`;
            hint.style.display = 'flex';
            document.getElementById(`commentInput-${postId}`).focus();
        }
        function cancelReply(postId) { replyTo = null; document.getElementById(`replyHint-${postId}`).style.display = 'none'; }

        async function submitComment(postId) {
            const input = document.getElementById(`commentInput-${postId}`);
            const content = input.value.trim();
            if (!content) return;
            try {
                const res = await db('comments', 'POST', { post_id: postId, username: currentUser.username, content, reply_to: replyTo?.postId === postId ? replyTo.commentId : null });
                if (res?.[0]) comments.push(res[0]);
                input.value = ''; cancelReply(postId); loadPosts();
            } catch (e) { alert('è¯„è®ºå¤±è´¥'); }
        }

        async function deleteComment(commentId, postId) {
            if (!confirm('åˆ é™¤è¯„è®ºï¼Ÿ')) return;
            try { await db('comments', 'DELETE', null, `?id=eq.${commentId}`); comments = comments.filter(c => c.id !== commentId); loadPosts(); } catch (e) { console.error(e); }
        }

        // ==================== ç›¸å†ŒåŠŸèƒ½ ====================
        function loadPhotos() {
            const filtered = currentFilter === 'all' ? photos : photos.filter(p => p.category === currentFilter);
            const grid = document.getElementById('albumGrid'), empty = document.getElementById('albumEmpty');
            if (!filtered.length) { grid.style.display = 'none'; empty.style.display = 'block'; return; }
            grid.style.display = 'block'; empty.style.display = 'none';
            const cats = { daily: 'æ—¥å¸¸', date: 'çº¦ä¼š', travel: 'æ—…è¡Œ', food: 'ç¾é£Ÿ' };
            const isOwner = currentUser?.role === 'owner';
            grid.innerHTML = filtered.map(p => `<div class="masonry-item"><img src="${p.src}" onclick="openLightbox('${p.src.replace(/'/g, "\\'")}')"><span class="photo-category">${cats[p.category] || 'æ—¥å¸¸'}</span>${isOwner ? `<button class="photo-delete" onclick="deletePhoto(${p.id},event)">Ã—</button>` : ''}</div>`).join('');
        }

        function filterAlbum(cat, btn) { currentFilter = cat; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadPhotos(); }

        async function uploadPhotos(input) {
            const cat = document.getElementById('albumCategory').value;
            showLoading();
            for (const file of input.files) { try { const d = await readFileAsDataURL(file); const c = await compressImage(d, 1000, 0.7); await db('photos', 'POST', { src: c, category: cat }); } catch (e) { console.error(e); } }
            photos = await db('photos', 'GET', null, '?order=created_at.desc') || [];
            loadPhotos(); hideLoading(); input.value = '';
        }

        async function deletePhoto(id, e) { e.stopPropagation(); if (!confirm('åˆ é™¤ç…§ç‰‡ï¼Ÿ')) return; try { await db('photos', 'DELETE', null, `?id=eq.${id}`); photos = photos.filter(p => p.id !== id); loadPhotos(); } catch (e) { console.error(e); } }

        // ==================== æ—¥è®°åŠŸèƒ½ ====================
        function loadDiaries() {
            const isOwner = currentUser?.role === 'owner';
            document.getElementById('diaryList').innerHTML = diaries.map(d => `<div class="diary-entry">${isOwner ? `<button class="delete-btn" onclick="deleteDiary(${d.id})">Ã—</button>` : ''}<div class="diary-date">${new Date(d.created_at).toLocaleString('zh-CN')}</div><div class="diary-content">${escapeHtml(d.content)}</div></div>`).join('');
        }

        async function addDiary() {
            const content = document.getElementById('diaryInput').value.trim();
            if (!content) return;
            try { await db('diaries', 'POST', { content }); document.getElementById('diaryInput').value = ''; diaries = await db('diaries', 'GET', null, '?order=created_at.desc') || []; loadDiaries(); } catch (e) { console.error(e); }
        }

        async function deleteDiary(id) { if (!confirm('åˆ é™¤æ—¥è®°ï¼Ÿ')) return; try { await db('diaries', 'DELETE', null, `?id=eq.${id}`); diaries = diaries.filter(d => d.id !== id); loadDiaries(); } catch (e) { console.error(e); } }

        // ==================== æ¸…å•åŠŸèƒ½ ====================
        function loadWishes() {
            const isOwner = currentUser?.role === 'owner';
            document.getElementById('wishList').innerHTML = wishes.map(w => `<div class="wishlist-item ${w.completed ? 'completed' : ''}"><div class="wishlist-checkbox ${w.completed ? 'checked' : ''}" onclick="${isOwner ? `toggleWish(${w.id})` : ''}" style="cursor:${isOwner ? 'pointer' : 'default'}">${w.completed ? 'âœ“' : ''}</div><span class="wishlist-text">${escapeHtml(w.text)}</span>${isOwner ? `<button class="wishlist-delete" onclick="deleteWish(${w.id})">Ã—</button>` : ''}</div>`).join('');
        }

        async function addWish() { const text = document.getElementById('wishInput').value.trim(); if (!text) return; try { await db('wishes', 'POST', { text, completed: false }); document.getElementById('wishInput').value = ''; wishes = await db('wishes', 'GET', null, '?order=created_at.asc') || []; loadWishes(); } catch (e) { console.error(e); } }
        async function toggleWish(id) { const w = wishes.find(x => x.id === id); if (!w) return; try { await db('wishes', 'PATCH', { completed: !w.completed }, `?id=eq.${id}`); w.completed = !w.completed; loadWishes(); } catch (e) { console.error(e); } }
        async function deleteWish(id) { try { await db('wishes', 'DELETE', null, `?id=eq.${id}`); wishes = wishes.filter(w => w.id !== id); loadWishes(); } catch (e) { console.error(e); } }

        // ==================== è®¿å®¢ç®¡ç† ====================
        function loadVisitors() {
            const visitors = users.filter(u => u.role === 'visitor');
            document.getElementById('visitorList').innerHTML = visitors.map(v => `<div class="visitor-item"><span>ğŸ‘¤ ${escapeHtml(v.username)}</span><button class="settings-btn danger" onclick="deleteVisitor(${v.id})" style="padding:5px 12px;font-size:11px">åˆ é™¤</button></div>`).join('') || '<p style="font-size:12px;color:var(--text-light)">æš‚æ— è®¿å®¢</p>';
        }

        async function addVisitor() {
            const name = document.getElementById('newVisitorName').value.trim(), pwd = document.getElementById('newVisitorPwd').value;
            if (!name || !pwd) { alert('è¯·å¡«å†™æ˜µç§°å’Œå¯†ç '); return; }
            if (users.some(u => u.username === name)) { alert('æ˜µç§°å·²å­˜åœ¨'); return; }
            try { const res = await db('users', 'POST', { username: name, password: pwd, role: 'visitor' }); if (res?.[0]) users.push(res[0]); document.getElementById('newVisitorName').value = ''; document.getElementById('newVisitorPwd').value = ''; loadVisitors(); alert('æ·»åŠ æˆåŠŸï¼'); } catch (e) { alert('æ·»åŠ å¤±è´¥'); }
        }

        async function deleteVisitor(id) { if (!confirm('åˆ é™¤è®¿å®¢ï¼Ÿ')) return; try { await db('users', 'DELETE', null, `?id=eq.${id}`); users = users.filter(u => u.id !== id); loadVisitors(); } catch (e) { console.error(e); } }

        async function changePassword() {
            const oldPwd = document.getElementById('oldPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            
            if (!oldPwd || !newPwd || !confirmPwd) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
            if (newPwd !== confirmPwd) { alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´'); return; }
            if (newPwd.length < 3) { alert('æ–°å¯†ç è‡³å°‘3ä½'); return; }
            
            try {
                // éªŒè¯æ—§å¯†ç 
                const u = await db('users', 'GET', null, `?username=eq.${encodeURIComponent(currentUser.username)}&role=eq.owner`);
                if (!u?.length || u[0].password !== oldPwd) { alert('æ—§å¯†ç é”™è¯¯'); return; }
                
                // æ›´æ–°æ–°å¯†ç 
                await db('users', 'PATCH', { password: newPwd }, `?username=eq.${encodeURIComponent(currentUser.username)}`);
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            } catch (e) { alert('ä¿®æ”¹å¤±è´¥'); console.error(e); }
        }

        async function uploadAvatar(num, input) {
            const file = input.files[0]; if (!file) return;
            showLoading();
            try { const d = await readFileAsDataURL(file); const c = await compressImage(d, 250, 0.8); document.getElementById(`avatar${num}`).innerHTML = `<img src="${c}">`; config[`avatar${num}`] = c; await saveConfig(); updateChatHeader(); } catch (e) { console.error(e); }
            hideLoading();
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function readFileAsDataURL(file) { return new Promise((r, j) => { const f = new FileReader(); f.onload = e => r(e.target.result); f.onerror = j; f.readAsDataURL(file); }); }
        function compressImage(dataUrl, maxSize, quality) {
            return new Promise(r => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxSize || h > maxSize) { if (w > h) { h = h / w * maxSize; w = maxSize; } else { w = w / h * maxSize; h = maxSize; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    r(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function setSyncStatus(s, t) { const e = document.getElementById('syncStatus'); e.className = 'sync-status ' + s; e.querySelector('span').textContent = t; }
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

        function startTimer() {
            function update() {
                if (!config.start_date) { document.getElementById('timerDays').textContent = '?'; return; }
                const diff = Date.now() - new Date(config.start_date).getTime();
                if (diff < 0) return;
                document.getElementById('timerDays').textContent = Math.floor(diff / 86400000);
                document.getElementById('timerHours').textContent = Math.floor(diff % 86400000 / 3600000);
                document.getElementById('timerMinutes').textContent = Math.floor(diff % 3600000 / 60000);
                document.getElementById('timerSeconds').textContent = Math.floor(diff % 60000 / 1000);
            }
            update(); setInterval(update, 1000);
        }

        function switchTab(name, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            if (name === 'chat') setTimeout(() => document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight, 100);
        }

        // ==================== ä¸»é¢˜ç‰¹æ•ˆ ====================
        function createStars() { const c = document.getElementById('stars'); for (let i = 0; i < 80; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${s.style.width};animation-delay:${Math.random()*2}s`; c.appendChild(s); } }
        function initTheme() { if (localStorage.getItem('theme') === 'night') { document.body.setAttribute('data-theme', 'night'); document.getElementById('btnTheme').textContent = 'â˜€ï¸'; } }
        function toggleTheme() { const n = document.body.getAttribute('data-theme') === 'night'; document.body.toggleAttribute('data-theme', !n); if (n) document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', 'night'); document.getElementById('btnTheme').textContent = n ? 'ğŸŒ™' : 'â˜€ï¸'; localStorage.setItem('theme', n ? 'day' : 'night'); }
        let fallingInterval;
        function startFalling() { if (fallingInterval) clearInterval(fallingInterval); fallingInterval = setInterval(createFallingItem, 350); }
        function createFallingItem() { const c = document.getElementById('fallingContainer'); const i = document.createElement('div'); i.className = 'falling-item'; i.textContent = fallingType === 'hearts' ? ['â¤ï¸','ğŸ’•','ğŸ’—','ğŸ’–'][Math.floor(Math.random()*4)] : ['ğŸŒ¸','ğŸµï¸','ğŸ’®'][Math.floor(Math.random()*3)]; i.style.cssText = `left:${Math.random()*100}%;font-size:${Math.random()*12+10}px;opacity:${Math.random()*0.4+0.3};animation-duration:${Math.random()*3+4}s`; c.appendChild(i); setTimeout(() => i.remove(), 7000); }
        function setFallingType(t) { fallingType = t; localStorage.setItem('fallingType', t); updateFallingButtons(); }
        function updateFallingButtons() { document.getElementById('btnHearts').classList.toggle('active', fallingType === 'hearts'); document.getElementById('btnPetals').classList.toggle('active', fallingType === 'petals'); }
        function initCursorTrail() { let last = 0; document.addEventListener('mousemove', e => { if (Date.now() - last < 60) return; last = Date.now(); const t = document.createElement('div'); t.className = 'cursor-trail'; t.textContent = ['ğŸ’•','âœ¨','ğŸ’–'][Math.floor(Math.random()*3)]; t.style.cssText = `left:${e.clientX}px;top:${e.clientY}px`; document.body.appendChild(t); setTimeout(() => t.remove(), 1000); }); }
        function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').classList.add('active'); }
        function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });
    </script>
</body>
</html>
