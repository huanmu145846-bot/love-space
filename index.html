<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’• æˆ‘ä»¬çš„å°çª</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fef9f3;
            --bg-secondary: #fff;
            --bg-card: #fff;
            --rose: #e8a4b8;
            --rose-light: #fce4ec;
            --rose-dark: #c48b9f;
            --text: #5d4e4e;
            --text-light: #8b7b7b;
            --shadow: rgba(200, 139, 159, 0.15);
            --gradient-header: linear-gradient(180deg, var(--rose-light) 0%, transparent 100%);
        }
        [data-theme="night"] {
            --bg-primary: #0f0c29;
            --bg-secondary: #1a1a3e;
            --bg-card: rgba(30, 30, 60, 0.95);
            --rose: #ff6b9d;
            --rose-light: #2d2d5a;
            --rose-dark: #ff8fab;
            --text: #e8e8f0;
            --text-light: #a8a8c0;
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient-header: linear-gradient(180deg, rgba(255, 107, 157, 0.2) 0%, transparent 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s, color 0.5s;
        }
        .stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.5s; }
        [data-theme="night"] .stars { opacity: 1; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .falling-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
        .falling-item { position: absolute; top: -50px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }
        .cursor-trail { position: fixed; pointer-events: none; z-index: 9999; font-size: 20px; animation: trailFade 1s ease-out forwards; }
        @keyframes trailFade { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(0.5) translateY(-30px); } }
        .login-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.8s, transform 0.8s; }
        .login-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        .login-box { text-align: center; padding: 60px 50px; background: var(--bg-card); backdrop-filter: blur(20px); border-radius: 30px; box-shadow: 0 25px 80px var(--shadow); max-width: 400px; width: 90%; border: 1px solid rgba(232, 164, 184, 0.2); position: relative; z-index: 10; }
        .login-hearts { font-size: 60px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .login-title { font-family: 'Ma Shan Zheng', cursive; font-size: 36px; color: var(--rose-dark); margin-bottom: 10px; }
        .login-subtitle { color: var(--text-light); font-size: 14px; margin-bottom: 40px; letter-spacing: 2px; }
        .login-input { width: 100%; padding: 18px 25px; border: 2px solid transparent; border-radius: 50px; background: var(--bg-secondary); font-size: 16px; text-align: center; color: var(--text); transition: all 0.3s; letter-spacing: 8px; font-family: inherit; }
        .login-input:focus { outline: none; border-color: var(--rose); box-shadow: 0 0 0 4px rgba(232, 164, 184, 0.2); }
        .login-input::placeholder { letter-spacing: 2px; color: var(--text-light); }
        .login-btn { width: 100%; padding: 18px; border: none; border-radius: 50px; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; font-size: 16px; cursor: pointer; margin-top: 20px; transition: all 0.3s; font-family: inherit; letter-spacing: 3px; }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(232, 164, 184, 0.4); }
        .login-error { color: #e57373; font-size: 14px; margin-top: 15px; opacity: 0; transition: opacity 0.3s; }
        .login-error.show { opacity: 1; }
        .sync-status { position: fixed; bottom: 20px; left: 20px; z-index: 100; padding: 10px 20px; border-radius: 20px; font-size: 12px; background: var(--bg-card); box-shadow: 0 3px 15px var(--shadow); display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .sync-status.syncing { color: #ffa726; }
        .sync-status.synced { color: #66bb6a; }
        .sync-status.error { color: #ef5350; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .sync-status.syncing .sync-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; gap: 10px; }
        .toggle-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text); font-size: 22px; cursor: pointer; box-shadow: 0 5px 20px var(--shadow); transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .toggle-btn:hover { transform: scale(1.1); }
        .toggle-btn.active { background: var(--rose); color: white; }
        .app { display: none; min-height: 100vh; position: relative; z-index: 2; }
        .app.active { display: block; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header-decor { height: 200px; background: var(--gradient-header); position: relative; overflow: hidden; }
        .header-decor::before { content: ''; position: absolute; top: -50%; left: -10%; width: 120%; height: 200%; background: radial-gradient(ellipse, rgba(232, 164, 184, 0.3) 0%, transparent 70%); animation: pulse-bg 8s ease-in-out infinite; }
        @keyframes pulse-bg { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .main-card { max-width: 900px; margin: -100px auto 40px; background: var(--bg-card); border-radius: 40px; padding: 50px; box-shadow: 0 30px 100px var(--shadow); position: relative; z-index: 10; transition: background 0.5s; }
        .couple-section { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 40px; }
        .avatar-wrapper { position: relative; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--bg-card); box-shadow: 0 10px 40px var(--shadow); cursor: pointer; transition: transform 0.3s; background: var(--rose-light); display: flex; align-items: center; justify-content: center; font-size: 40px; overflow: hidden; }
        .avatar:hover { transform: scale(1.05); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-name { text-align: center; margin-top: 12px; }
        .avatar-name input { border: none; background: transparent; text-align: center; font-family: inherit; font-size: 14px; color: var(--text); width: 100px; padding: 5px; border-radius: 20px; transition: background 0.3s; }
        .avatar-name input:focus { outline: none; background: var(--rose-light); }
        .heart-connector { font-size: 50px; color: var(--rose); animation: heartbeat 1.5s ease-in-out infinite; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .timer-section { text-align: center; padding: 40px 0; border-top: 1px solid var(--rose-light); border-bottom: 1px solid var(--rose-light); margin-bottom: 40px; }
        .timer-title { font-family: 'ZCOOL XiaoWei', serif; font-size: 18px; color: var(--text-light); margin-bottom: 15px; }
        .timer-date-input { font-family: inherit; font-size: 16px; padding: 10px 20px; border: 2px dashed var(--rose-light); border-radius: 30px; background: transparent; color: var(--text); cursor: pointer; margin-bottom: 25px; }
        .timer-date-input:focus { outline: none; border-color: var(--rose); }
        .timer-display { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .timer-unit { text-align: center; }
        .timer-number { font-family: 'Ma Shan Zheng', cursive; font-size: 56px; color: var(--rose-dark); line-height: 1; }
        .timer-label { font-size: 14px; color: var(--text-light); margin-top: 5px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border: none; background: var(--rose-light); color: var(--text); border-radius: 30px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .tab-btn:hover { background: var(--rose); color: white; }
        .tab-btn.active { background: var(--rose-dark); color: white; }
        .tab-content { display: none; animation: slideUp 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .post-form { background: var(--rose-light); border-radius: 25px; padding: 25px; margin-bottom: 25px; }
        .post-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .post-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--rose); display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .post-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .post-author-select { padding: 8px 20px; border: 2px solid var(--rose); border-radius: 20px; background: var(--bg-card); color: var(--text); font-family: inherit; cursor: pointer; }
        .post-textarea { width: 100%; min-height: 100px; border: none; background: var(--bg-card); border-radius: 20px; padding: 20px; font-family: inherit; font-size: 15px; resize: none; color: var(--text); }
        .post-textarea:focus { outline: none; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
        .post-image-btn { padding: 10px 20px; border: 2px dashed var(--rose); background: transparent; color: var(--rose-dark); border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .post-image-btn:hover { background: var(--rose); color: white; border-style: solid; }
        .post-submit { padding: 12px 35px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 30px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .post-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(232, 164, 184, 0.4); }
        .post-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .post-image-preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .preview-item { width: 80px; height: 80px; border-radius: 10px; overflow: hidden; position: relative; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; font-size: 12px; }
        .posts-list { display: flex; flex-direction: column; gap: 25px; }
        .post-item { background: var(--bg-card); border-radius: 25px; padding: 25px; box-shadow: 0 5px 30px var(--shadow); border: 1px solid var(--rose-light); }
        .post-item-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .post-item-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--rose); display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
        .post-item-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .post-item-info { flex: 1; }
        .post-item-name { font-weight: 500; color: var(--text); margin-bottom: 3px; }
        .post-item-date { font-size: 12px; color: var(--text-light); }
        .post-item-delete { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 18px; opacity: 0; transition: opacity 0.3s; }
        .post-item:hover .post-item-delete { opacity: 1; }
        .post-item-content { line-height: 1.8; white-space: pre-wrap; margin-bottom: 15px; }
        .post-item-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .post-item-images.single { grid-template-columns: 1fr; max-width: 400px; }
        .post-item-images.double { grid-template-columns: repeat(2, 1fr); max-width: 400px; }
        .post-item-images img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; cursor: pointer; transition: transform 0.3s; }
        .post-item-images img:hover { transform: scale(1.02); }
        .post-item-footer { display: flex; gap: 20px; padding-top: 15px; border-top: 1px solid var(--rose-light); }
        .post-action-btn { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--text-light); cursor: pointer; font-family: inherit; font-size: 14px; padding: 8px 15px; border-radius: 20px; transition: all 0.3s; }
        .post-action-btn:hover { background: var(--rose-light); color: var(--rose-dark); }
        .post-action-btn.liked { color: var(--rose); }
        .album-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 20px; border: 2px solid var(--rose-light); background: transparent; color: var(--text); border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 13px; transition: all 0.3s; }
        .filter-btn:hover, .filter-btn.active { background: var(--rose); border-color: var(--rose); color: white; }
        .album-upload-section { background: var(--rose-light); border-radius: 20px; padding: 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .album-category-select { padding: 10px 20px; border: 2px solid var(--rose); border-radius: 20px; background: var(--bg-card); color: var(--text); font-family: inherit; cursor: pointer; }
        .album-upload-btn { padding: 10px 25px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .album-upload-btn:hover { transform: translateY(-2px); }
        .masonry-grid { column-count: 3; column-gap: 15px; }
        .masonry-item { break-inside: avoid; margin-bottom: 15px; border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; transition: transform 0.3s; }
        .masonry-item:hover { transform: scale(1.02); }
        .masonry-item img { width: 100%; display: block; }
        .masonry-item .photo-category { position: absolute; top: 10px; left: 10px; padding: 4px 12px; background: rgba(0,0,0,0.5); color: white; border-radius: 12px; font-size: 12px; }
        .masonry-item .photo-delete { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.5); color: white; border: none; cursor: pointer; font-size: 16px; display: none; align-items: center; justify-content: center; }
        .masonry-item:hover .photo-delete { display: flex; }
        .album-empty { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .album-empty-icon { font-size: 60px; margin-bottom: 15px; }
        .diary-form { background: var(--rose-light); border-radius: 25px; padding: 25px; margin-bottom: 25px; }
        .diary-textarea { width: 100%; min-height: 120px; border: none; background: var(--bg-card); border-radius: 20px; padding: 20px; font-family: inherit; font-size: 15px; resize: none; color: var(--text); }
        .diary-textarea:focus { outline: none; }
        .diary-submit { padding: 12px 35px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 30px; cursor: pointer; font-family: inherit; font-size: 14px; margin-top: 15px; transition: all 0.3s; }
        .diary-submit:hover { transform: translateY(-2px); }
        .diary-list { display: flex; flex-direction: column; gap: 20px; }
        .diary-entry { background: var(--bg-card); border-radius: 25px; padding: 25px; border-left: 4px solid var(--rose); box-shadow: 0 5px 20px var(--shadow); position: relative; }
        .diary-date { font-size: 12px; color: var(--text-light); margin-bottom: 10px; }
        .diary-content { line-height: 1.8; white-space: pre-wrap; }
        .diary-entry .delete-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 18px; opacity: 0; transition: opacity 0.3s; }
        .diary-entry:hover .delete-btn { opacity: 1; }
        .wishlist-form { display: flex; gap: 10px; margin-bottom: 25px; }
        .wishlist-input { flex: 1; padding: 15px 25px; border: 2px solid var(--rose-light); border-radius: 30px; font-family: inherit; font-size: 15px; color: var(--text); background: var(--bg-card); }
        .wishlist-input:focus { outline: none; border-color: var(--rose); }
        .wishlist-add { padding: 15px 30px; border: none; background: linear-gradient(135deg, var(--rose) 0%, var(--rose-dark) 100%); color: white; border-radius: 30px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .wishlist-add:hover { transform: translateY(-2px); }
        .wishlist-items { display: flex; flex-direction: column; gap: 12px; }
        .wishlist-item { display: flex; align-items: center; gap: 15px; padding: 18px 25px; background: var(--bg-card); border-radius: 20px; box-shadow: 0 3px 15px var(--shadow); transition: all 0.3s; }
        .wishlist-item.completed { background: var(--rose-light); }
        .wishlist-item.completed .wishlist-text { text-decoration: line-through; color: var(--text-light); }
        .wishlist-checkbox { width: 24px; height: 24px; border: 2px solid var(--rose); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.3s; }
        .wishlist-checkbox.checked { background: var(--rose); color: white; }
        .wishlist-text { flex: 1; }
        .wishlist-delete { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 18px; opacity: 0; transition: opacity 0.3s; }
        .wishlist-item:hover .wishlist-delete { opacity: 1; }
        .settings-section { background: var(--rose-light); border-radius: 25px; padding: 30px; margin-bottom: 20px; }
        .settings-title { font-family: 'ZCOOL XiaoWei', serif; font-size: 18px; margin-bottom: 20px; color: var(--text); }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.3); flex-wrap: wrap; gap: 10px; }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { font-size: 14px; }
        .settings-input { padding: 10px 20px; border: 2px solid var(--bg-card); border-radius: 20px; font-family: inherit; font-size: 14px; background: var(--bg-card); color: var(--text); }
        .settings-input:focus { outline: none; border-color: var(--rose-dark); }
        .settings-btn { padding: 10px 25px; border: none; background: var(--rose-dark); color: white; border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.3s; }
        .settings-btn:hover { background: var(--rose); }
        .settings-btn.danger { background: #e57373; }
        .settings-btn.danger:hover { background: #ef5350; }
        .footer { text-align: center; padding: 40px 20px; color: var(--text-light); font-size: 13px; }
        .footer-heart { color: var(--rose); animation: heartbeat 1.5s ease-in-out infinite; display: inline-block; }
        .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .hidden-input { display: none; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--rose-light); border-top-color: var(--rose); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .masonry-grid { column-count: 2; } }
        @media (max-width: 600px) {
            .main-card { margin: -80px 15px 30px; padding: 30px 20px; border-radius: 30px; }
            .couple-section { gap: 15px; }
            .avatar { width: 80px; height: 80px; font-size: 30px; }
            .heart-connector { font-size: 30px; }
            .timer-number { font-size: 40px; }
            .tabs { gap: 8px; }
            .tab-btn { padding: 10px 15px; font-size: 13px; }
            .wishlist-form { flex-direction: column; }
            .login-box { padding: 40px 30px; }
            .login-title { font-size: 28px; }
            .theme-toggle { top: 10px; right: 10px; }
            .toggle-btn { width: 40px; height: 40px; font-size: 18px; }
            .post-item-images { grid-template-columns: repeat(2, 1fr); }
            .sync-status { bottom: 10px; left: 10px; padding: 8px 15px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="falling-container" id="fallingContainer"></div>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-hearts">ğŸ’‘</div>
            <h1 class="login-title">æˆ‘ä»¬çš„å°çª</h1>
            <p class="login-subtitle">è¾“å…¥ä¸“å±å¯†ç è¿›å…¥</p>
            <input type="password" class="login-input" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " maxlength="20">
            <button class="login-btn" onclick="tryLogin()">è¿›å…¥å°çª ğŸ’•</button>
            <p class="login-error" id="loginError">å¯†ç ä¸å¯¹å“¦ï¼Œå†è¯•è¯•ï½</p>
        </div>
    </div>
    <div class="sync-status synced" id="syncStatus"><div class="sync-dot"></div><span>å·²åŒæ­¥</span></div>
    <div class="theme-toggle">
        <button class="toggle-btn active" id="btnHearts" onclick="setFallingType('hearts')" title="é£˜è½çˆ±å¿ƒ">â¤ï¸</button>
        <button class="toggle-btn" id="btnPetals" onclick="setFallingType('petals')" title="é£˜è½èŠ±ç“£">ğŸŒ¸</button>
        <button class="toggle-btn" id="btnTheme" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </div>
    <div class="app" id="app">
        <div class="header-decor"></div>
        <div class="main-card">
            <div class="couple-section">
                <div class="avatar-wrapper">
                    <div class="avatar" id="avatar1" onclick="document.getElementById('avatarInput1').click()">ğŸ‘¦</div>
                    <input type="file" id="avatarInput1" class="hidden-input" accept="image/*" onchange="uploadAvatar(1, this)">
                    <div class="avatar-name"><input type="text" id="name1" placeholder="ä»–çš„åå­—" onchange="saveConfig()"></div>
                </div>
                <div class="heart-connector">ğŸ’•</div>
                <div class="avatar-wrapper">
                    <div class="avatar" id="avatar2" onclick="document.getElementById('avatarInput2').click()">ğŸ‘§</div>
                    <input type="file" id="avatarInput2" class="hidden-input" accept="image/*" onchange="uploadAvatar(2, this)">
                    <div class="avatar-name"><input type="text" id="name2" placeholder="å¥¹çš„åå­—" onchange="saveConfig()"></div>
                </div>
            </div>
            <div class="timer-section">
                <p class="timer-title">æˆ‘ä»¬åœ¨ä¸€èµ·å·²ç»</p>
                <input type="date" class="timer-date-input" id="startDate" onchange="saveConfig()">
                <div class="timer-display">
                    <div class="timer-unit"><div class="timer-number" id="timerDays">0</div><div class="timer-label">å¤©</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerHours">0</div><div class="timer-label">æ—¶</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerMinutes">0</div><div class="timer-label">åˆ†</div></div>
                    <div class="timer-unit"><div class="timer-number" id="timerSeconds">0</div><div class="timer-label">ç§’</div></div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('posts', this)">ğŸ’¬ è¯´è¯´</button>
                <button class="tab-btn" onclick="switchTab('album', this)">ğŸ“¸ ç›¸å†Œ</button>
                <button class="tab-btn" onclick="switchTab('diary', this)">ğŸ“ æ—¥è®°</button>
                <button class="tab-btn" onclick="switchTab('wishlist', this)">ğŸ¯ æ¸…å•</button>
                <button class="tab-btn" onclick="switchTab('settings', this)">âš™ï¸ è®¾ç½®</button>
            </div>
            <div class="tab-content active" id="tab-posts">
                <div class="post-form">
                    <div class="post-header">
                        <div class="post-avatar" id="postAvatar">ğŸ‘¤</div>
                        <select class="post-author-select" id="postAuthor" onchange="updatePostAvatar()">
                            <option value="1">ä»–</option>
                            <option value="2">å¥¹</option>
                        </select>
                    </div>
                    <textarea class="post-textarea" id="postContent" placeholder="æ­¤åˆ»çš„å¿ƒæƒ…..."></textarea>
                    <div class="post-image-preview" id="postImagePreview"></div>
                    <div class="post-actions">
                        <button class="post-image-btn" onclick="document.getElementById('postImageInput').click()">ğŸ“· æ·»åŠ å›¾ç‰‡</button>
                        <input type="file" id="postImageInput" class="hidden-input" accept="image/*" multiple onchange="previewPostImages(this)">
                        <button class="post-submit" id="postSubmitBtn" onclick="publishPost()">å‘å¸ƒè¯´è¯´ ğŸ’Œ</button>
                    </div>
                </div>
                <div class="posts-list" id="postsList"></div>
            </div>
            <div class="tab-content" id="tab-album">
                <div class="album-filters">
                    <button class="filter-btn active" onclick="filterAlbum('all', this)">å…¨éƒ¨</button>
                    <button class="filter-btn" onclick="filterAlbum('daily', this)">ğŸ“… æ—¥å¸¸</button>
                    <button class="filter-btn" onclick="filterAlbum('date', this)">ğŸ’‘ çº¦ä¼š</button>
                    <button class="filter-btn" onclick="filterAlbum('travel', this)">âœˆï¸ æ—…è¡Œ</button>
                    <button class="filter-btn" onclick="filterAlbum('food', this)">ğŸœ ç¾é£Ÿ</button>
                </div>
                <div class="album-upload-section">
                    <span>ä¸Šä¼ åˆ°ï¼š</span>
                    <select class="album-category-select" id="albumCategory">
                        <option value="daily">ğŸ“… æ—¥å¸¸</option>
                        <option value="date">ğŸ’‘ çº¦ä¼š</option>
                        <option value="travel">âœˆï¸ æ—…è¡Œ</option>
                        <option value="food">ğŸœ ç¾é£Ÿ</option>
                    </select>
                    <button class="album-upload-btn" onclick="document.getElementById('photoInput').click()">ğŸ“· ä¸Šä¼ ç…§ç‰‡</button>
                    <input type="file" id="photoInput" class="hidden-input" accept="image/*" multiple onchange="uploadPhotos(this)">
                </div>
                <div class="masonry-grid" id="albumGrid"></div>
                <div class="album-empty" id="albumEmpty" style="display:none;"><div class="album-empty-icon">ğŸ“·</div><p>è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ å§ï½</p></div>
            </div>
            <div class="tab-content" id="tab-diary">
                <div class="diary-form">
                    <textarea class="diary-textarea" id="diaryInput" placeholder="ä»Šå¤©æƒ³è®°å½•ä»€ä¹ˆå‘¢..."></textarea>
                    <button class="diary-submit" onclick="addDiary()">å‘å¸ƒæ—¥è®° ğŸ’Œ</button>
                </div>
                <div class="diary-list" id="diaryList"></div>
            </div>
            <div class="tab-content" id="tab-wishlist">
                <div class="wishlist-form">
                    <input type="text" class="wishlist-input" id="wishInput" placeholder="æƒ³å’ŒTAä¸€èµ·åšçš„äº‹...">
                    <button class="wishlist-add" onclick="addWish()">æ·»åŠ </button>
                </div>
                <div class="wishlist-items" id="wishList"></div>
            </div>
            <div class="tab-content" id="tab-settings">
                <div class="settings-section">
                    <h3 class="settings-title">ğŸ” ä¿®æ”¹å¯†ç </h3>
                    <div class="settings-item"><span class="settings-label">æ–°å¯†ç </span><input type="password" class="settings-input" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç "></div>
                    <div class="settings-item"><span class="settings-label"></span><button class="settings-btn" onclick="changePassword()">ä¿å­˜å¯†ç </button></div>
                </div>
                <div class="settings-section">
                    <h3 class="settings-title">â˜ï¸ äº‘ç«¯åŒæ­¥</h3>
                    <div class="settings-item"><span class="settings-label">åŒæ­¥çŠ¶æ€</span><span id="syncInfo">å·²è¿æ¥äº‘ç«¯</span></div>
                    <div class="settings-item"><span class="settings-label">æ‰‹åŠ¨åŒæ­¥</span><button class="settings-btn" onclick="manualSync()">ç«‹å³åŒæ­¥</button></div>
                </div>
            </div>
        </div>
        <footer class="footer">ç”¨ <span class="footer-heart">â¤ï¸</span> è®°å½•æˆ‘ä»¬çš„æ¯ä¸€å¤©<br><small style="opacity:0.6">â˜ï¸ æ•°æ®å·²äº‘ç«¯åŒæ­¥</small></footer>
    </div>
    <div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightboxImg" src="" alt=""></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <script>
        // ==================== Supabase é…ç½® ====================
        const SUPABASE_URL = 'https://qzsnxxvjxzvgnzaliwsa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6c254eHZqeHp2Z256YWxpd3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4MzIzNDAsImV4cCI6MjA1NDQwODM0MH0.lPpGKczgN2rxMjUHqgKJYG_x9BiqxCqPmV9XL6xH5jk';
        
        // Supabase API è¾…åŠ©å‡½æ•°
        async function supabaseRequest(table, method = 'GET', body = null, query = '') {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const options = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': method === 'POST' ? 'return=representation' : (method === 'PATCH' ? 'return=representation' : '')
                }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                return text ? JSON.parse(text) : null;
            } catch (err) {
                console.error('Supabase error:', err);
                throw err;
            }
        }

        // ==================== å…¨å±€å˜é‡ ====================
        let config = { password: '520', start_date: '', name1: '', name2: '', avatar1: '', avatar2: '' };
        let posts = [];
        let photos = [];
        let diaries = [];
        let wishes = [];
        let pendingPostImages = [];
        let currentFilter = 'all';
        let fallingType = localStorage.getItem('fallingType') || 'hearts';
        let fallingInterval;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async () => {
            createStars();
            initTheme();
            updateFallingButtons();
            startFalling();
            initCursorTrail();
            
            document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') tryLogin(); });
            document.getElementById('wishInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addWish(); });
            
            // åŠ è½½äº‘ç«¯é…ç½®æ£€æŸ¥å¯†ç 
            await loadConfig();
            
            if (sessionStorage.getItem('loveSpace_loggedIn')) {
                showApp();
            }
        });

        // ==================== åŒæ­¥çŠ¶æ€æ˜¾ç¤º ====================
        function setSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            el.querySelector('span').textContent = text;
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

        // ==================== äº‘ç«¯æ•°æ®æ“ä½œ ====================
        async function loadConfig() {
            try {
                setSyncStatus('syncing', 'åŒæ­¥ä¸­...');
                const data = await supabaseRequest('config', 'GET', null, '?id=eq.main');
                if (data && data.length > 0) {
                    config = { ...config, ...data[0] };
                }
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åŒæ­¥å¤±è´¥');
                console.error('Load config error:', err);
            }
        }

        async function saveConfig() {
            config.name1 = document.getElementById('name1').value;
            config.name2 = document.getElementById('name2').value;
            config.start_date = document.getElementById('startDate').value;
            
            try {
                setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
                await supabaseRequest('config', 'PATCH', {
                    name1: config.name1,
                    name2: config.name2,
                    start_date: config.start_date,
                    avatar1: config.avatar1,
                    avatar2: config.avatar2,
                    updated_at: new Date().toISOString()
                }, '?id=eq.main');
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'ä¿å­˜å¤±è´¥');
            }
        }

        async function loadAllData() {
            showLoading();
            try {
                setSyncStatus('syncing', 'åŠ è½½æ•°æ®...');
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [postsData, photosData, diariesData, wishesData] = await Promise.all([
                    supabaseRequest('posts', 'GET', null, '?order=created_at.desc'),
                    supabaseRequest('photos', 'GET', null, '?order=created_at.desc'),
                    supabaseRequest('diaries', 'GET', null, '?order=created_at.desc'),
                    supabaseRequest('wishes', 'GET', null, '?order=created_at.asc')
                ]);
                
                posts = postsData || [];
                photos = photosData || [];
                diaries = diariesData || [];
                wishes = wishesData || [];
                
                // æ¸²æŸ“ç•Œé¢
                renderConfig();
                loadPosts();
                loadPhotos();
                loadDiaries();
                loadWishes();
                updatePostAvatar();
                
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åŠ è½½å¤±è´¥');
                console.error('Load all data error:', err);
            }
            hideLoading();
        }

        function renderConfig() {
            document.getElementById('name1').value = config.name1 || '';
            document.getElementById('name2').value = config.name2 || '';
            document.getElementById('startDate').value = config.start_date || '';
            
            if (config.avatar1) document.getElementById('avatar1').innerHTML = '<img src="' + config.avatar1 + '">';
            if (config.avatar2) document.getElementById('avatar2').innerHTML = '<img src="' + config.avatar2 + '">';
        }

        // ==================== ç™»å½• ====================
        async function tryLogin() {
            const input = document.getElementById('passwordInput').value;
            if (input === config.password) {
                sessionStorage.setItem('loveSpace_loggedIn', 'true');
                showApp();
            } else {
                document.getElementById('loginError').classList.add('show');
                document.getElementById('passwordInput').value = '';
                setTimeout(() => document.getElementById('loginError').classList.remove('show'), 2000);
            }
        }

        async function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.add('active');
            await loadAllData();
            startTimer();
        }

        // ==================== è¯´è¯´åŠŸèƒ½ ====================
        function updatePostAvatar() {
            const author = document.getElementById('postAuthor').value;
            const avatarEl = document.getElementById('postAvatar');
            const savedAvatar = author === '1' ? config.avatar1 : config.avatar2;
            avatarEl.innerHTML = savedAvatar ? '<img src="' + savedAvatar + '">' : (author === '1' ? 'ğŸ‘¦' : 'ğŸ‘§');
        }

        function previewPostImages(input) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    // å‹ç¼©å›¾ç‰‡
                    compressImage(e.target.result, 800, 0.8).then(compressed => {
                        pendingPostImages.push(compressed);
                        renderPostImagePreview();
                    });
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        function renderPostImagePreview() {
            document.getElementById('postImagePreview').innerHTML = pendingPostImages.map((img, i) => 
                '<div class="preview-item"><img src="' + img + '"><button class="preview-remove" onclick="removePostImage(' + i + ')">Ã—</button></div>'
            ).join('');
        }

        function removePostImage(index) { pendingPostImages.splice(index, 1); renderPostImagePreview(); }

        async function publishPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content && pendingPostImages.length === 0) return;
            
            const btn = document.getElementById('postSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'å‘å¸ƒä¸­...';
            
            try {
                setSyncStatus('syncing', 'å‘å¸ƒä¸­...');
                const author = document.getElementById('postAuthor').value;
                
                await supabaseRequest('posts', 'POST', {
                    author,
                    content,
                    images: pendingPostImages,
                    likes: 0,
                    liked: false
                });
                
                document.getElementById('postContent').value = '';
                pendingPostImages = [];
                document.getElementById('postImagePreview').innerHTML = '';
                
                // é‡æ–°åŠ è½½è¯´è¯´
                const postsData = await supabaseRequest('posts', 'GET', null, '?order=created_at.desc');
                posts = postsData || [];
                loadPosts();
                
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'å‘å¸ƒå¤±è´¥');
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            btn.disabled = false;
            btn.textContent = 'å‘å¸ƒè¯´è¯´ ğŸ’Œ';
        }

        function loadPosts() {
            document.getElementById('postsList').innerHTML = posts.map(post => {
                const name = post.author === '1' ? (config.name1 || 'ä»–') : (config.name2 || 'å¥¹');
                const avatar = post.author === '1' ? config.avatar1 : config.avatar2;
                const date = new Date(post.created_at).toLocaleString('zh-CN');
                
                let imagesHtml = '';
                if (post.images && post.images.length > 0) {
                    const gridClass = post.images.length === 1 ? 'single' : (post.images.length === 2 ? 'double' : '');
                    imagesHtml = '<div class="post-item-images ' + gridClass + '">' + 
                        post.images.map(img => '<img src="' + img + '" onclick="openLightbox(\'' + img.replace(/'/g, "\\'") + '\')">').join('') + '</div>';
                }
                
                return '<div class="post-item"><div class="post-item-header"><div class="post-item-avatar">' + 
                    (avatar ? '<img src="' + avatar + '">' : (post.author === '1' ? 'ğŸ‘¦' : 'ğŸ‘§')) + 
                    '</div><div class="post-item-info"><div class="post-item-name">' + name + '</div><div class="post-item-date">' + date + 
                    '</div></div><button class="post-item-delete" onclick="deletePost(' + post.id + ')">Ã—</button></div>' + 
                    (post.content ? '<div class="post-item-content">' + escapeHtml(post.content) + '</div>' : '') + imagesHtml + 
                    '<div class="post-item-footer"><button class="post-action-btn ' + (post.liked ? 'liked' : '') + 
                    '" onclick="toggleLike(' + post.id + ')">' + (post.liked ? 'â¤ï¸' : 'ğŸ¤') + ' <span>' + post.likes + '</span></button></div></div>';
            }).join('');
        }

        async function toggleLike(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            const newLiked = !post.liked;
            const newLikes = post.likes + (newLiked ? 1 : -1);
            
            try {
                await supabaseRequest('posts', 'PATCH', { liked: newLiked, likes: newLikes }, '?id=eq.' + postId);
                post.liked = newLiked;
                post.likes = newLikes;
                loadPosts();
            } catch (err) {
                console.error('Toggle like error:', err);
            }
        }

        async function deletePost(postId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯´è¯´å—ï¼Ÿ')) return;
            try {
                setSyncStatus('syncing', 'åˆ é™¤ä¸­...');
                await supabaseRequest('posts', 'DELETE', null, '?id=eq.' + postId);
                posts = posts.filter(p => p.id !== postId);
                loadPosts();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åˆ é™¤å¤±è´¥');
            }
        }

        // ==================== ç›¸å†ŒåŠŸèƒ½ ====================
        function loadPhotos() {
            const filtered = currentFilter === 'all' ? photos : photos.filter(p => p.category === currentFilter);
            const grid = document.getElementById('albumGrid');
            const empty = document.getElementById('albumEmpty');
            
            if (filtered.length === 0) { grid.style.display = 'none'; empty.style.display = 'block'; return; }
            grid.style.display = 'block'; empty.style.display = 'none';
            
            const categoryNames = { daily: 'æ—¥å¸¸', date: 'çº¦ä¼š', travel: 'æ—…è¡Œ', food: 'ç¾é£Ÿ' };
            grid.innerHTML = filtered.map(photo => 
                '<div class="masonry-item"><img src="' + photo.src + '" onclick="openLightbox(\'' + photo.src.replace(/'/g, "\\'") + 
                '\')"><span class="photo-category">' + (categoryNames[photo.category] || 'æ—¥å¸¸') + 
                '</span><button class="photo-delete" onclick="deletePhoto(' + photo.id + ', event)">Ã—</button></div>'
            ).join('');
        }

        function filterAlbum(category, btn) {
            currentFilter = category;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadPhotos();
        }

        async function uploadPhotos(input) {
            const category = document.getElementById('albumCategory').value;
            showLoading();
            
            for (const file of input.files) {
                try {
                    const dataUrl = await readFileAsDataURL(file);
                    const compressed = await compressImage(dataUrl, 1200, 0.8);
                    
                    setSyncStatus('syncing', 'ä¸Šä¼ ä¸­...');
                    await supabaseRequest('photos', 'POST', { src: compressed, category });
                } catch (err) {
                    console.error('Upload photo error:', err);
                }
            }
            
            // é‡æ–°åŠ è½½ç›¸å†Œ
            const photosData = await supabaseRequest('photos', 'GET', null, '?order=created_at.desc');
            photos = photosData || [];
            loadPhotos();
            setSyncStatus('synced', 'å·²åŒæ­¥');
            hideLoading();
            input.value = '';
        }

        async function deletePhoto(photoId, e) {
            e.stopPropagation();
            if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;
            try {
                setSyncStatus('syncing', 'åˆ é™¤ä¸­...');
                await supabaseRequest('photos', 'DELETE', null, '?id=eq.' + photoId);
                photos = photos.filter(p => p.id !== photoId);
                loadPhotos();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åˆ é™¤å¤±è´¥');
            }
        }

        // ==================== æ—¥è®°åŠŸèƒ½ ====================
        function loadDiaries() {
            document.getElementById('diaryList').innerHTML = diaries.map(diary => {
                const date = new Date(diary.created_at).toLocaleString('zh-CN');
                return '<div class="diary-entry"><button class="delete-btn" onclick="deleteDiary(' + diary.id + ')">Ã—</button>' +
                    '<div class="diary-date">' + date + '</div><div class="diary-content">' + escapeHtml(diary.content) + '</div></div>';
            }).join('');
        }

        async function addDiary() {
            const content = document.getElementById('diaryInput').value.trim();
            if (!content) return;
            
            try {
                setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
                await supabaseRequest('diaries', 'POST', { content });
                document.getElementById('diaryInput').value = '';
                
                const diariesData = await supabaseRequest('diaries', 'GET', null, '?order=created_at.desc');
                diaries = diariesData || [];
                loadDiaries();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'ä¿å­˜å¤±è´¥');
            }
        }

        async function deleteDiary(diaryId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) return;
            try {
                setSyncStatus('syncing', 'åˆ é™¤ä¸­...');
                await supabaseRequest('diaries', 'DELETE', null, '?id=eq.' + diaryId);
                diaries = diaries.filter(d => d.id !== diaryId);
                loadDiaries();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åˆ é™¤å¤±è´¥');
            }
        }

        // ==================== æ¸…å•åŠŸèƒ½ ====================
        function loadWishes() {
            document.getElementById('wishList').innerHTML = wishes.map(wish => 
                '<div class="wishlist-item ' + (wish.completed ? 'completed' : '') + '">' +
                '<div class="wishlist-checkbox ' + (wish.completed ? 'checked' : '') + '" onclick="toggleWish(' + wish.id + ')">' + 
                (wish.completed ? 'âœ“' : '') + '</div><span class="wishlist-text">' + escapeHtml(wish.text) + 
                '</span><button class="wishlist-delete" onclick="deleteWish(' + wish.id + ')">Ã—</button></div>'
            ).join('');
        }

        async function addWish() {
            const text = document.getElementById('wishInput').value.trim();
            if (!text) return;
            
            try {
                setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
                await supabaseRequest('wishes', 'POST', { text, completed: false });
                document.getElementById('wishInput').value = '';
                
                const wishesData = await supabaseRequest('wishes', 'GET', null, '?order=created_at.asc');
                wishes = wishesData || [];
                loadWishes();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'ä¿å­˜å¤±è´¥');
            }
        }

        async function toggleWish(wishId) {
            const wish = wishes.find(w => w.id === wishId);
            if (!wish) return;
            
            try {
                await supabaseRequest('wishes', 'PATCH', { completed: !wish.completed }, '?id=eq.' + wishId);
                wish.completed = !wish.completed;
                loadWishes();
            } catch (err) {
                console.error('Toggle wish error:', err);
            }
        }

        async function deleteWish(wishId) {
            try {
                setSyncStatus('syncing', 'åˆ é™¤ä¸­...');
                await supabaseRequest('wishes', 'DELETE', null, '?id=eq.' + wishId);
                wishes = wishes.filter(w => w.id !== wishId);
                loadWishes();
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'åˆ é™¤å¤±è´¥');
            }
        }

        // ==================== è®¾ç½®åŠŸèƒ½ ====================
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) { alert('è¯·è¾“å…¥æ–°å¯†ç '); return; }
            
            try {
                setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
                await supabaseRequest('config', 'PATCH', { password: newPassword }, '?id=eq.main');
                config.password = newPassword;
                document.getElementById('newPassword').value = '';
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
                setSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (err) {
                setSyncStatus('error', 'ä¿å­˜å¤±è´¥');
                alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function manualSync() {
            await loadAllData();
            alert('åŒæ­¥å®Œæˆï¼');
        }

        // ==================== å¤´åƒä¸Šä¼  ====================
        async function uploadAvatar(num, input) {
            const file = input.files[0];
            if (!file) return;
            
            showLoading();
            try {
                const dataUrl = await readFileAsDataURL(file);
                const compressed = await compressImage(dataUrl, 300, 0.8);
                
                document.getElementById('avatar' + num).innerHTML = '<img src="' + compressed + '">';
                config['avatar' + num] = compressed;
                
                await saveConfig();
            } catch (err) {
                console.error('Upload avatar error:', err);
            }
            hideLoading();
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function compressImage(dataUrl, maxSize, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== è®¡æ—¶å™¨ ====================
        function startTimer() {
            function update() {
                const startDate = config.start_date;
                if (!startDate) { document.getElementById('timerDays').textContent = '?'; return; }
                const diff = new Date() - new Date(startDate);
                if (diff < 0) { 
                    document.getElementById('timerDays').textContent = '0';
                    document.getElementById('timerHours').textContent = '0';
                    document.getElementById('timerMinutes').textContent = '0';
                    document.getElementById('timerSeconds').textContent = '0';
                    return;
                }
                document.getElementById('timerDays').textContent = Math.floor(diff / 86400000);
                document.getElementById('timerHours').textContent = Math.floor((diff % 86400000) / 3600000);
                document.getElementById('timerMinutes').textContent = Math.floor((diff % 3600000) / 60000);
                document.getElementById('timerSeconds').textContent = Math.floor((diff % 60000) / 1000);
            }
            update();
            setInterval(update, 1000);
        }

        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // ==================== ä¸»é¢˜å’Œç‰¹æ•ˆ ====================
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'day';
            if (savedTheme === 'night') {
                document.body.setAttribute('data-theme', 'night');
                document.getElementById('btnTheme').textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            const isNight = document.body.getAttribute('data-theme') === 'night';
            if (isNight) {
                document.body.removeAttribute('data-theme');
                document.getElementById('btnTheme').textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'day');
            } else {
                document.body.setAttribute('data-theme', 'night');
                document.getElementById('btnTheme').textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'night');
            }
        }

        function startFalling() {
            if (fallingInterval) clearInterval(fallingInterval);
            fallingInterval = setInterval(() => createFallingItem(), 300);
        }

        function createFallingItem() {
            const container = document.getElementById('fallingContainer');
            const item = document.createElement('div');
            item.className = 'falling-item';
            item.textContent = fallingType === 'hearts' ? ['â¤ï¸', 'ğŸ’•', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜'][Math.floor(Math.random() * 5)] : ['ğŸŒ¸', 'ğŸµï¸', 'ğŸ’®', 'ğŸŒº'][Math.floor(Math.random() * 4)];
            item.style.left = Math.random() * 100 + '%';
            item.style.fontSize = (Math.random() * 15 + 10) + 'px';
            item.style.opacity = Math.random() * 0.5 + 0.3;
            item.style.animationDuration = (Math.random() * 3 + 4) + 's';
            container.appendChild(item);
            setTimeout(() => item.remove(), 7000);
        }

        function setFallingType(type) {
            fallingType = type;
            localStorage.setItem('fallingType', type);
            updateFallingButtons();
        }

        function updateFallingButtons() {
            document.getElementById('btnHearts').classList.toggle('active', fallingType === 'hearts');
            document.getElementById('btnPetals').classList.toggle('active', fallingType === 'petals');
        }

        function initCursorTrail() {
            let lastTime = 0;
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                if (now - lastTime < 50) return;
                lastTime = now;
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.textContent = ['ğŸ’•', 'âœ¨', 'ğŸ’–', 'â¤ï¸'][Math.floor(Math.random() * 4)];
                trail.style.left = e.clientX + 'px';
                trail.style.top = e.clientY + 'px';
                document.body.appendChild(trail);
                setTimeout(() => trail.remove(), 1000);
            });
        }

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
    </script>
</body>
</html>
